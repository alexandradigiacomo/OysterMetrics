---
title: "smoothedComparison"
author: "Alexandra DiGiacomo"
date: "10/15/2020"
output: html_document
---


```{r, message = FALSE}
# load packages

library(dplyr)
library(ggplot2)
library(raster)
library(sp)
library(rgdal)
library(spatialEco)
library(rasterVis)
library(rgl) 
```

## Load Data
```{r , message = FALSE}
# load smoothed data
IL5 <- raster("C:/aed41/Projects/OysterMetrics/data/Products/smoothed/1L5_best_dsm.tif")
CCA3 <- raster("C:/aed41/Projects/OysterMetrics/data/Products/smoothed/CCA3_Final_dsm.tif")
Natural <- raster("C:/aed41/Projects/OysterMetrics/data/Products/smoothed/Natural_low_test_dsm.tif")


# load nonsmoothed data
IL5_ns <- raster("C:/aed41/Projects/OysterMetrics/data/Products/non-smoothed/1L5_best_dsm_nonsmoothed.tif")
CCA3_ns <- raster("C:/aed41/Projects/OysterMetrics/data/Products/non-smoothed/CCA3_Final_dsm_nonsmoothed.tif")
Natural_ns <- raster("C:/aed41/Projects/OysterMetrics/data/Products/non-smoothed/Natural_low_test_dsm_nonsmoothed.tif")
```

# Generate Downsampled Rasters
```{r, cache = TRUE, include = FALSE}
# smoothed
IL52 <- aggregate(IL5, fact = 2, fun = "mean")
IL54 <- aggregate(IL5, fact = 4, fun = "mean")
IL58 <- aggregate(IL5, fact = 8, fun = "mean")
IL516 <-aggregate(IL5, fact = 16, fun = "mean")

CCA32 <- aggregate(CCA3, fact = 2, fun = "mean")
CCA34 <- aggregate(CCA3, fact = 4, fun = "mean")
CCA38 <- aggregate(CCA3, fact = 8, fun = "mean")
CCA316 <-aggregate(CCA3, fact = 16, fun = "mean")

Natural2 <- aggregate(Natural, fact = 2, fun = "mean")
Natural4 <- aggregate(Natural, fact = 4, fun = "mean")
Natural8 <- aggregate(Natural, fact = 8, fun = "mean")
Natural16 <-aggregate(Natural, fact = 16, fun = "mean")

# nonsmoothed
IL52_ns <- aggregate(IL5_ns, fact = 2, fun = "mean")
IL54_ns <- aggregate(IL5_ns, fact = 4, fun = "mean")
IL58_ns <- aggregate(IL5_ns, fact = 8, fun = "mean")
IL516_ns <-aggregate(IL5_ns, fact = 16, fun = "mean")

CCA32_ns <- aggregate(CCA3_ns, fact = 2, fun = "mean")
CCA34_ns <- aggregate(CCA3_ns, fact = 4, fun = "mean")
CCA38_ns <- aggregate(CCA3_ns, fact = 8, fun = "mean")
CCA316_ns <-aggregate(CCA3_ns, fact = 16, fun = "mean")

Natural2_ns <- aggregate(Natural_ns, fact = 2, fun = "mean")
Natural4_ns <- aggregate(Natural_ns, fact = 4, fun = "mean")
Natural8_ns <- aggregate(Natural_ns, fact = 8, fun = "mean")
Natural16_ns <-aggregate(Natural_ns, fact = 16, fun = "mean")
```

# Calculate Slope and Aspect
```{r}
# generate iteratable lists
list = c(IL5, IL52, IL54, IL58, IL516, IL5_ns, IL52_ns, IL54_ns, IL58_ns, IL516_ns,
         CCA3, CCA32, CCA34, CCA38, CCA316, CCA3_ns, CCA32_ns, CCA34_ns, CCA38_ns, CCA316_ns,
         Natural, Natural2, Natural4, Natural8, Natural16, Natural_ns, Natural2_ns, Natural4_ns,
         Natural8_ns, Natural16_ns)
names = c('IL5', 'IL52', 'IL54', 'IL58', "IL516", "IL5_ns", "IL52_ns", "IL54_ns", 
          "IL58_ns", "IL516_ns",
         "CCA3", "CCA32", "CCA34", "CCA38", 'CCA316', "CCA3_ns", "CCA32_ns", 
         "CCA34_ns", "CCA38_ns", "CCA316_ns",
         "Natural", "Natural2", "Natural4", "Natural8", "Natural16", 
         "Natural_ns", "Natural2_ns", "Natural4_ns", "Natural8_ns", "Natural16_ns")

newnames = c() # initialize empty list for new slopeAs objects

# loop
i = 1
for (i in 1:length(list)) {
  nam = paste(names[i], "slopAs", sep = "")

  rast = list[[i]] # grab name of raster
  
  slopeAs <- terrain(rast, opt = c("slope", "aspect"), unit = "degrees") # calc slope/aspect
  assign(nam, slopeAs)
  
  newnames <- append(newnames, nam)
  i = i + 1 # move pointer
}

```

# Plot Slope and Aspect
```{r, fig.height = 3, fig.width = 5}
i = 1
for (i in 1:length(newnames)) {
  jpeg(file = paste("C:/aed41/Projects/OysterMetrics/results/slopeAspectFigures/",
                       paste(newnames[[i]], ".png", sep = ""), sep = ""),
       width = 600, height = 400)
  plot(eval(parse(text = newnames[[i]])), main = newnames[[i]])
  dev.off()
}
```

## Create Raster Stacks of Slope/Aspect Across Resolutions/Smoothing
```{r}
rasStackIL5 = stack(IL5slopAs, resample(IL52slopAs, IL5slopAs), 
                 resample(IL54slopAs, IL5slopAs),
                 resample(IL58slopAs, IL5slopAs),
                 resample(IL516slopAs, IL5slopAs),
                 resample(IL5_nsslopAs, IL5slopAs),
                 resample(IL52_nsslopAs, IL5slopAs),
                 resample(IL54_nsslopAs, IL5slopAs),
                 resample(IL58_nsslopAs, IL5slopAs),
                 resample(IL516_nsslopAs, IL5slopAs))

rasStackNatural = stack(NaturalslopAs, resample(Natural2slopAs, NaturalslopAs), 
                 resample(Natural4slopAs, NaturalslopAs),
                 resample(Natural8slopAs, NaturalslopAs),
                 resample(Natural16slopAs, NaturalslopAs),
                 resample(Natural_nsslopAs, NaturalslopAs),
                 resample(Natural2_nsslopAs, NaturalslopAs),
                 resample(Natural4_nsslopAs, NaturalslopAs),
                 resample(Natural8_nsslopAs, NaturalslopAs),
                 resample(Natural16_nsslopAs, NaturalslopAs))

rasStackCCA3 = stack(CCA3slopAs, resample(CCA32slopAs, CCA3slopAs), 
                 resample(CCA34slopAs, CCA3slopAs),
                 resample(CCA38slopAs, CCA3slopAs),
                 resample(CCA316slopAs, CCA3slopAs),
                 resample(CCA3_nsslopAs, CCA3slopAs),
                 resample(CCA32_nsslopAs, CCA3slopAs),
                 resample(CCA34_nsslopAs, CCA3slopAs),
                 resample(CCA38_nsslopAs, CCA3slopAs),
                 resample(CCA316_nsslopAs, CCA3slopAs))
```


# Vertical Height Profile Check
Traverse a horizontal transect across the raster (a row of the raster matrix) and visualize changes in the vertical profile across resolutions and smoothed/unsmoothed techniques

```{r}
# extract three horizontal rows for profile

# IL5
nrowIL5 <- dim(rasStackIL5)[1] # num rows in this raster
trowIL5 <- round(nrowIL5/4) # cut the raster into quarters horizontally, take middle three transects

transect1_IL5 <- as.data.frame(getValues(rasStackIL5, trow, 1)) %>%
  mutate(id = row_number())
transect2_IL5 <- as.data.frame(getValues(rasStackIL5, trow*2, 1)) %>%
  mutate(id = row_number())
transect3_IL5 <- as.data.frame(getValues(rasStackIL5, trow*3, 1)) %>%
  mutate(id = row_number())

# Natural
nrowNatural <- dim(rasStackNatural)[1] # num rows in this raster
trowNatural <- round(nrowNatural/4) # cut the raster into quarters horizontally, take middle three transects

transect1_Natural <- as.data.frame(getValues(rasStackNatural, trowNatural, 1)) %>%
  mutate(id = row_number())
transect2_Natural <- as.data.frame(getValues(rasStackNatural, trowNatural*2, 1)) %>%
  mutate(id = row_number())
transect3_Natural <- as.data.frame(getValues(rasStackNatural, trowNatural*3, 1)) %>%
  mutate(id = row_number())

# CCA3
nrowCCA3 <- dim(rasStackCCA3)[1] # num rows in this raster
trowCCA3 <- round(nrowCCA3/4) # cut the raster into quarters horizontally, take middle three transects

transect1_CCA3 <- as.data.frame(getValues(rasStackCCA3, trowCCA3, 1)) %>%
  mutate(id = row_number())
transect2_CCA3 <- as.data.frame(getValues(rasStackCCA3, trowCCA3*2, 1)) %>%
  mutate(id = row_number())
transect3_CCA3 <- as.data.frame(getValues(rasStackCCA3, trowCCA3*3, 1)) %>%
  mutate(id = row_number())
```

Reformat Data for Plotting
```{r plotverticalProfile}
transects = c(transect1_IL5, transect2_IL5, transect3_IL5, transect1_Natural, transect2_Natural,
      transect3_Natural, transect1_CCA3, transect2_CCA3, transect3_CCA3)

i = 1
for (i in 1:length(transects)) {
  nam = paste(transects[i], "_mod", sep = "")
  focus_transect = transects[[i]] # grab name of transect to focus on
  
  newdf <- as.data.frame(focus_transect) %>%
    dplyr::select(!(starts_with("aspect"))) %>%
    pivot_longer(cols= starts_with("slope"), names_to = "slope", values_to = "value") %>%
    mutate(type = case_when(slope ==
                    "slope.1" ~ "1xGSD smoothed",
                    "slope.2" ~ "2xGSD smoothed",
                    "slope.3" ~ "4xGSD smoothed",
                    "slope.4" ~ "8xGSD smoothed",
                    "slope.5" ~ "16xGSD smoothed",
                    "slope.6" ~ "1xGSD unsmoothed",
                    "slope.7" ~ "2xGSD unsmoothed",
                    "slope.8" ~ "4xGSD unsmoothed",
                    "slope.9" ~ "8xGSD unsmoothed",
                    "slope.10" ~ "16xGSD unsmoothed",
                   ))

  assign(nam, newdf)
  i = i + 1
}


transect1_IL5

dev.new()
plot(x = (transect1_IL5$id)*0.5, y = transect1_IL5$slope.1, type = 'l', col = 'blue')
plot(x = (transect1_IL5$id)*0.5, y = transect1_IL5$slope.2, type = 'l', col = 'light blue')
plot(x = transect1$id, y = transect1$slope.3, type = 'l', col = 'blue')
plot(x = transect1$id, y = transect1$slope.4, type = 'l', col = 'dark blue')
plot(x = transect1$id, y = transect1$slope.5, type = 'l', col = 'green')
```

Plot: 1L5 Unsmoothed
```{r}
dev.new()
plot(x = transect1$id, y = transect1$slope.6, type = 'l', col = 'blue')
plot(x = (transect1$id)*0.5, y = transect1$slope.7, type = 'l', col = 'light blue')
plot(x = transect1$id, y = transect1$slope.8, type = 'l', col = 'blue')
plot(x = transect1$id, y = transect1$slope.9, type = 'l', col = 'dark blue')
plot(x = transect1$id, y = transect1$slope.10, type = 'l', col = 'green')
```

Smoothed aspect (need circular statistics for this actually)
```{r}
dev.new()
plot(x = transect1$id, y = transect1$aspect.1, type = 'l', col = 'blue')
plot(x = transect1$id, y = transect1$aspect.2, type = 'l', col = 'light blue')
plot(x = transect1$id, y = transect1$aspect.3, type = 'l', col = 'blue')
plot(x = transect1$id, y = transect1$aspect.4, type = 'l', col = 'dark blue')
plot(x = transect1$id, y = transect1$aspect.5, type = 'l', col = 'green')
```

Unsmoothed aspect
```{r}
dev.new()
plot(x = transect1$id, y = transect1$aspect.1, type = 'l', col = 'blue')
plot(x = transect1$id, y = transect1$aspect.2, type = 'l', col = 'light blue')
plot(x = transect1$id, y = transect1$aspect.3, type = 'l', col = 'blue')
plot(x = transect1$id, y = transect1$aspect.4, type = 'l', col = 'dark blue')
plot(x = transect1$id, y = transect1$aspect.5, type = 'l', col = 'green')
```



## Generate Random Samples
```{r}
set.seed(2020)
randomPts <- sampleRandom(IL5slopAs, 10, na.rm= TRUE, sp = TRUE)
rasValue = extract(rasStackIL5, randomPts)
combinePointValue = cbind(randomPts, rasValue)
df <- as.data.frame(combinePointValue)
```

Modify dataframe for visualization
```{r, include = FALSE}
df_t1 <- df[,1:2] %>%
  mutate(GSD = 1) %>%
  mutate(smoothed = "yes") %>%
  mutate(obs = c(1:10))

df_t2 <- df[,3:4] %>%
  mutate(GSD = 2) %>%
  mutate(smoothed = "yes") %>%
  mutate(obs = c(1:10))
colnames(df_t2) = colnames(df_t1)

df_t3 <- df[,5:6] %>%
  mutate(GSD = 4) %>%
  mutate(smoothed = "yes") %>%
  mutate(obs = c(1:10))
colnames(df_t3) = colnames(df_t1)

df_t4 <- df[,7:8] %>%
  mutate(GSD = 8) %>%
  mutate(smoothed = "yes") %>%
  mutate(obs = c(1:10))
colnames(df_t4) = colnames(df_t1)

df_t5 <- df[,9:10] %>%
  mutate(GSD = 16) %>%
  mutate(smoothed = "yes") %>%
  mutate(obs = c(1:10))
colnames(df_t5) = colnames(df_t1)

df_t6 <- df[,11:12] %>%
  mutate(GSD = 1) %>%
  mutate(smoothed = "no") %>%
  mutate(obs = c(1:10))
colnames(df_t6) = colnames(df_t1)

df_t7 <- df[,13:14] %>%
  mutate(GSD = 2) %>%
  mutate(smoothed = "no") %>%
  mutate(obs = c(1:10))
colnames(df_t7) = colnames(df_t1)

df_t8 <- df[,15:16] %>%
  mutate(GSD = 4) %>%
  mutate(smoothed = "no") %>%
  mutate(obs = c(1:10))
colnames(df_t8) = colnames(df_t1)

df_t9 <- df[,17:18] %>%
  mutate(GSD = 8) %>%
  mutate(smoothed = "no") %>%
  mutate(obs = c(1:10))
colnames(df_t9) = colnames(df_t1)

df_t10 <- df[,19:20] %>%
  mutate(GSD = 16) %>%
  mutate(smoothed = "no") %>%
  mutate(obs = c(1:10))
colnames(df_t10) = colnames(df_t1)

df_samples <- rbind(df_t1, df_t2, df_t3, df_t4, df_t5, df_t6, df_t7, 
      df_t8, df_t9, df_t10)
```

# Visualize Samples
```{r}
df_samples %>%
  ggplot(aes(x = GSD, y = slope, fill = as.factor(GSD))) + 
  geom_boxplot() + theme_minimal() + facet_wrap(~smoothed) +
  ggtitle("IL5 Slope") + theme(legend.title = element_blank())

df_samples %>%
  ggplot(aes(x = GSD, y = aspect, fill = as.factor(GSD))) + 
  geom_boxplot() + theme_minimal() + facet_wrap(~smoothed) +
  ggtitle("IL5 Aspect") + theme(legend.title = element_blank())

df_sum <- df_samples %>%
  group_by(GSD, smoothed) %>%
  summarize(meanSlop = mean(slope), varSlop = sd(slope),
            meanAsp = mean(aspect), varAsp = sd(aspect)) 
df_sum %>%
  ggplot(aes(x = GSD, y = meanSlop, color = smoothed)) + 
  geom_errorbar(aes(ymin = meanSlop - varSlop,ymax = meanSlop + varSlop),
                width = 0.2) +
  geom_point(size = 3) + theme_minimal() +
  ggtitle("IL5 Slope")  + ylab("mean slope (degrees)") + xlab("x GSD")

df_sum %>%
  ggplot(aes(x = GSD, y = meanAsp, color = smoothed)) + 
  geom_errorbar(aes(ymin = meanAsp - varAsp, 
                                           ymax = meanAsp + varAsp),
                                       width = 0.2) +
  geom_point(size = 3) + theme_minimal() +
  ggtitle("IL5 Aspect") + ylab("mean aspect (degrees)") + xlab("x GSD")

```
